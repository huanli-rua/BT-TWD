# 航空延误二分类（基于 100 万条 ARFF 数据）的端到端配置

DATA:
  dataset_name: "airlines_delay_1m"                              # 数据集名称
  raw_path: "../data/airline/airlines_train_regression_1000000.arff" # 数据文件路径（相对仓库根目录）
  file_type: "arff"                                               # 数据文件类型：ARFF
  target_col: "DepDelay"                                         # 原始目标列（延误分钟，回归值）
  target_transform:                                               # 将回归值转为二分类标签
    type: "threshold_binary"                                     # 按阈值二分类
    threshold: 15.0                                               # 大于该阈值视为延误
    greater_is_positive: true                                     # > 阈值为正类
    new_col: "label"                                             # 新的标签列名
  positive_label: 1                                               # 正类取值（延误）
  negative_label: 0                                               # 负类取值（未延误）
  use_kfold: true                                                 # 是否使用 K 折（保持与 adult 默认一致）
  n_splits: 5                                                     # K 折折数
  shuffle: true                                                   # K 折是否洗牌
  stratify: true                                                  # 分层抽样
  random_state: 42                                                # 随机种子
  split:                                                          # （可选）显式划分比例，供脚本自定义切分时使用
    strategy: "random_stratified"                                # 随机分层划分
    train_ratio: 0.5                                              # 训练集比例
    val_ratio: 0.2                                                # 验证集比例
    test_ratio: 0.3                                               # 测试集比例
    random_state: 42                                              # 切分随机种子

PREPROCESS:
  continuous_cols:                                               # 数值特征列表
    - "Month"          # 月份
    - "DayofMonth"     # 日
    - "DayOfWeek"      # 星期
    - "CRSDepTime"     # 计划起飞时间 (HHMM)
    - "CRSArrTime"     # 计划到达时间 (HHMM)
    - "Distance"       # 航程距离 (英里)
  categorical_cols:                                             # 类别特征列表
    - "UniqueCarrier"  # 航司
    - "Origin"         # 起飞机场
    - "Dest"           # 到达机场
  handle_missing: "question_mark"                               # 缺失值处理方式
  fillna_strategy: "most_frequent"                               # 填充策略（与 adult 保持一致）
  scale_continuous: true                                         # 是否缩放数值特征
  scaler_type: "standard"                                        # 数值特征缩放器
  encoding_type: "onehot"                                        # 类别编码方式
  drop_first: true                                               # One-Hot 是否去掉首列
  drop_cols: []                                                  # 额外需要丢弃的列（此处为空，DepDelay 会在目标变换中排除）
  save_feature_names: true                                       # 是否保存特征名

SCORE:
  bucket_score_mode: "bac_regret"                                    # 增益只用于判定弱桶（是否回退阈值/模型），不再作为是否继续分裂的条件
  bac_weight: 1.0
  regret_weight: 1.0
  regret_sign: -1.0

BTTWD:
  bucket_levels:                                                 # 候选桶树层（通过注释开关组合）



    # ======= 候选层 1：航司（建议常开）=======
    - level: 1
      name: "L1_carrier"
      type: "categorical_group"               # 按航司分组：大航司单独建桶，小航司合并为 OTHER_CARRIER
      col: "UniqueCarrier"
      min_count: 4000                         # 样本数 >= 4000 的航司单独成桶，其余归为 OTHER_CARRIER
      other_label: "OTHER_CARRIER"

    # ======= 候选层 2：起飞机场 =======
    - level: 2
      name: "L2_origin"
      type: "categorical_group"               # 按起飞机场分组：大机场单独建桶，小机场合并为 OTHER_ORIGIN
      col: "Origin"
      min_count: 3000                         # 样本数 >= 3000 的机场单独成桶，其余归为 OTHER_ORIGIN
      other_label: "OTHER_ORIGIN"

    # ======= 候选层 3：目的机场（可选，一般关闭）=======
    # - level: 3
    #   name: "L3_dest"
    #   type: "categorical_group"             # 按目的机场分组：大机场单独建桶，小机场合并为 OTHER_DEST
    #   col: "Dest"
    #   min_count: 3000                       # 可以和 Origin 保持同一量级
    #   other_label: "OTHER_DEST"



    # ======= 候选层 5：月份（季度层）=======
    # - level: 5
    #   name: "L3_season"
    #   type: "numeric_bin"                                     # 按季度分箱
    #   col: "Month"
    #   bins: [3,6,9]
    #   labels: ["Q1","Q2","Q3","Q4"]

    # ======= 候选层 6：起飞时段 =======
    - level: 3
      name: "L3_deptime"
      type: "numeric_bin"                                       # 起飞时间段分箱
      col: "CRSDepTime"
      bins: [600,1200,1800,2400]
      labels: ["night","morning","afternoon","evening","late"]

          # ======= 候选层 4：航程距离 =======
    - level: 4
      name: "L2_distance"
      type: "numeric_bin"                                       # 航程距离分箱
      col: "Distance"
      bins: [300, 800, 1500, 5000]
      labels: ["<=300", "300-800", "800-1500", "1500-5000", ">5000"]

  min_bucket_size: 50                                          # 分桶停止条件之一：当前桶样本数 < min_bucket_size 时不再继续往下分
                                                              # 本数据集不单独限制每桶正样本数，分桶只看总样本数和层数
  use_min_bucket_size_limit: true                              # 是否启用按最小样本数限制继续分桶
  use_merge_small_to_residual: true # 是否将小于 min_bucket_size 的子桶合并到 residual/others（与最小样本限制解耦）
  max_levels: 4                                                 # 桶树最大层数，达到后强制停止分裂，与 gain 无关
  use_gain: true                                                # 预留参数，增益只参与弱桶判定和阈值回退，不影响是否分桶
  min_gain_for_split: -0.006                                      # 用于弱桶判定的增益阈值：增益 < 该值 的桶会被标记为弱桶，阈值/模型回退父桶/全局
  use_gain_weak_backoff: true                                  # 是否启用基于增益判定的弱桶回退逻辑
  gamma_bucket: 0.00                                             # 多一个子桶的复杂度惩罚，类似 XGBoost 的 gamma
  bucket_subsample: 0.7                                          # 桶内随机采样比例（类似 XGBoost 的 subsample）
  max_train_samples_per_bucket: 20000                            # 每个桶最多用于训练的样本数
  parent_share_rate: 0.2                                         # 预留参数，当前版本代码未使用父桶样本回流逻辑，仅作为以后扩展用
  min_parent_share: 60                                         # 预留参数，当前版本代码未使用父桶样本回流逻辑，仅作为以后扩展用
  val_ratio: 0.3                                                 # 只要桶内验证集样本数 >= min_val_samples_per_bucket，就单独搜阈值，否则记为弱桶回退
  min_val_samples_per_bucket: 20                                # 只要桶内验证集样本数 >= min_val_samples_per_bucket，就单独搜阈值，否则记为弱桶回退
  use_global_backoff: true                                       # 桶或父桶无模型时是否使用全局模型
  global_estimator: "xgb"                                        # 全局模型类型（XGBoost）
  bucket_estimator: "none"                                        # 桶内模型类型
  posterior_estimator: "logreg"                                  # 后验估计或校准模型
  logreg_C: 1.0                                                  # 逻辑回归正则系数
  knn_k: 10                                                      # KNN 邻居数
  knn_weights: "distance"                                        # KNN 距离加权策略
  bucket_rf:                                                     # 桶内随机森林参数占位（当前未启用）
    n_estimators: 200
    max_depth: null
    random_state: 42
    n_jobs: -1
  bucket_xgb:                                                    # 桶内 XGBoost 参数占位（当前未启用）
    n_estimators: 200
    max_depth: 3
    learning_rate: 0.1
    subsample: 0.8
    colsample_bytree: 0.8
    reg_lambda: 1.0
    random_state: 42
    n_jobs: -1
  global_xgb:                                                    # 全局 XGBoost 模型参数
    n_estimators: 300
    max_depth: 4
    learning_rate: 0.1
    subsample: 0.8
    colsample_bytree: 0.8
    reg_lambda: 1.0
    random_state: 42
    n_jobs: -1

THRESHOLDS:
  thresholds_mode: "bucket_wise"                                # 阈值模式，目前只支持 bucket_wise；字段名需与代码中的 thresholds_mode 对齐
  objective: "regret"                                           # 当前实现固定以 regret 为主目标，BAC/F1/BND 仅作 tie-breaker
  alpha_init: 0.6                                                # 正类阈值初始值
  beta_init: 0.4                                                 # 负类阈值初始值
  alpha_grid: [0.2,0.3,0.4,0.5, 0.6, 0.7,0.8, 0.9]                        # α 搜索网格
  beta_grid: [0.1,0.2, 0.3, 0.4, 0.5]                          # β 搜索网格
  gap_min: 0.05                                                  # α、β 最小间隔
  costs:                                                         # 三支决策成本
    C_TP: 0.0                                                    # 真正类成本
    C_TN: 0.0                                                    # 真负类成本
    C_FP: 1.0                                                    # 假正类成本（误报）
    C_FN: 5.0                                                    # 假负类成本（漏报）
    C_BP: 1.5                                                    # 边界-正成本
    C_BN: 1.0                                                    # 边界-负成本
  min_samples_for_thresholds: 200                               # 桶内验证样本数 ≥ 200 才在该桶上单独搜索阈值，否则直接回退父桶/ROOT 阈值
  max_iter: 100                                                  # 阈值搜索最大迭代次数占位（兼容配置）

BASELINES:
  use_logreg: false                                               # 是否跑逻辑回归基线
  use_random_forest: false                                       # 是否跑随机森林基线
  use_knn: false                                                  # 是否跑 KNN 基线
  use_xgboost: true                                              # 是否跑 XGBoost 基线

  common:
    threshold_mode: "per_model"                                  # "fixed" / "per_model"，默认 fixed
    fixed_threshold: 0.2                                         # 全局默认阈值

  logreg:
    C: 1.0                                                       # 逻辑回归正则化强度
    max_iter: 500                                                # 最大迭代次数
    use_custom_threshold: true
    custom_threshold: 0.15
  random_forest:
    n_estimators: 200                                            # 随机森林树数
    max_depth: null                                              # 随机森林深度
    random_state: 42                                             # 随机种子
    use_custom_threshold: true
    custom_threshold: 0.15
  knn:
    n_neighbors: 50                                              # 基线 KNN 邻居数
    use_custom_threshold: true
    custom_threshold: 0.15
  xgboost:
    n_estimators: 300                                            # 基线 XGBoost 树数
    max_depth: 4                                                 # 树深
    learning_rate: 0.1                                           # 学习率
    subsample: 0.8                                               # 行采样
    colsample_bytree: 0.8                                        # 列采样
    reg_lambda: 1.0                                              # L2 正则
    random_state: 42                                             # 随机种子
    n_jobs: -1                                                   # 并行线程
    use_custom_threshold: true
    custom_threshold: 0.2

EXP:
  kfold_repeats: 1                                               # K 折重复次数
  n_jobs: -1                                                     # 全局并行线程
  verbose: 1                                                     # 日志级别

METRICS:
  use_metrics: ["Precision", "Recall", "F1", "BAC", "AUC", "MCC", "Kappa", "Regret"] # 评估指标
  pos_label: 1                                                   # 指定正类标签

OUTPUT:
  results_dir: "results/airlines_delay_1m"                      # BTTWDModel 导出的 bucket_* CSV 会写在这个目录下
  figs_dir: "figs"                                              # 图表输出目录
  save_per_fold_metrics: true                                    # 是否保存分折指标
  save_bucket_metrics: true                                      # 是否保存桶指标
  save_config_copy: true                                         # 是否保存配置副本
  save_threshold_logs: true                                      # 是否保存阈值搜索日志
  threshold_log_filename: "bucket_thresholds_per_fold.csv"       # 阈值日志文件名

SEED:
  global_seed: 42                                                # 全局随机种子
